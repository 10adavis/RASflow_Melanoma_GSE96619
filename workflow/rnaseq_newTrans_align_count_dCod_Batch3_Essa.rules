configfile: "../configs/config_batch3_essa_newTrans.yaml"

samples = [1716412, 1716512, 1716812, 1717012, 1717812, 1718012, 1708012, 1708612, 1709112, 1709212, 1724712, 1725412, 1725712, 1725912, 1726812, 1709912, 1710012, 1710312, 1710412, 1710512, 1722912, 1723512, 1723812, 1723912]
indexes = list(range(1, 9))

rule all:
    input:
        final = expand(config["OUTPUTPATH"] + "countFile/{sample}.count", sample = samples)

rule indexTrans:
    input:
        trans = config["TRANS"]
    output:
        indexes = expand(config["OUTPUTPATH"] + "indexes/index.{index}.ht2", index = indexes)
    params:
        index = config["OUTPUTPATH"] + "indexes/index"
    shell:
        "hisat2-build -p {config[NCORE]} {input.trans} {params.index}"

rule getReads:
    input:
        key = config["KEY"]
    output:
        forward = temp(config["OUTPUTPATH"] + "reads/{sample}_forward.fastq.gz"),
        reverse = temp(config["OUTPUTPATH"] + "reads/{sample}_reverse.fastq.gz")
    run:
        shell("scp -i {input.key} {config[NELSIN]}/{wildcards.sample}_S*_R1_001.fastq.gz {output.forward}")
        shell("scp -i {input.key} {config[NELSIN]}/{wildcards.sample}_S*_R2_001.fastq.gz {output.reverse}")

rule alignment:
    input:
        index = expand(config["OUTPUTPATH"] + "indexes/index.{index}.ht2", index = indexes),
        forward = config["OUTPUTPATH"] + "reads/{sample}_forward.fastq.gz",
        reverse = config["OUTPUTPATH"] + "reads/{sample}_reverse.fastq.gz"
    output:
        sam = temp(config["OUTPUTPATH"] + "samFile/{sample}.sam"),
        bam = temp(config["OUTPUTPATH"] + "bamFile/{sample}.bam")
    wildcard_constraints:
        sample = "\d+"
    params:
        index = config["OUTPUTPATH"] + "indexes/index"
    benchmark:
        config["OUTPUTPATH"] + "benchmarks/{sample}.hisat2.benchmark.txt"
    shell:
        "hisat2 -p {config[NCORE]} -x {params.index} -1 {input.forward} -2 {input.reverse} -S {output.sam}"
        " && samtools view -b -S {output.sam} > {output.bam}"

rule sortIndex:
    input:
        bam = config["OUTPUTPATH"] + "bamFile/{sample}.bam"
    output:
        sort = config["OUTPUTPATH"] + "bamFile/{sample}.sort.bam"
    wildcard_constraints:
        sample = "\d+"
    shell:
        "samtools sort {input.bam} -o {output.sort} && samtools index {output.sort}"

rule featureCount:
    input:
        sort = config["OUTPUTPATH"] + "bamFile/{sample}.sort.bam"
    output:
        count = config["OUTPUTPATH"] + "countFile/{sample}.count"
    wildcard_constraints:
        sample = "\d+"
    shell:
        "samtools idxstats {input.sort} > {output.count}"

