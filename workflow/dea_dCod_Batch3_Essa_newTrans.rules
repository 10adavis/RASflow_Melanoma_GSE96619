configfile: "../configs/config_batch3_essa_newTrans.yaml"

samples = [1716412, 1716512, 1716812, 1717012, 1717812, 1718012, 1708012, 1708612, 1709112, 1709212, 1724712, 1725412, 1725712, 1725912, 1726812, 1709912, 1710012, 1710312, 1710412, 1710512, 1722912, 1723512, 1723812, 1723912]
groups = ["control", "PAH_low", "PAH_high", "PFAS_low", "PFAS_high"]
chemicals = ["PAH_low", "PAH_high", "PFAS_low", "PFAS_high"]

rule all:
    input:
        chemical_dea = expand(config["OUTPUTPATH"] + "DEA/edger/dea_control_{chemical}.csv", chemical = chemicals),
        chemical_deg = expand(config["OUTPUTPATH"] + "DEA/edger/deg_control_{chemical}.csv", chemical = chemicals)

# The rule below is not flexibal, needs to change manually, the used script combine_essa_pah_pfas.sh is only suitable for PAH_PFAS
rule combineSamples:
    input:
        geneCount = expand(config["OUTPUTPATH"] + "countFile/{sample}.count", sample = samples)
    output:
        expand(config["OUTPUTPATH"] + "countFile/{group}.count", group = groups)
    params:
        path = config["OUTPUTPATH"] + "countFile"
    shell:
        "cp ../scripts/combine_essa_pah_pfas.sh {params.path} && cd {params.path} && bash combine_essa_pah_pfas.sh && rm combine_essa_pah_pfas.sh"

rule prepareDEA:
    input:
        control = config["OUTPUTPATH"] + "countFile/control.count",
        PAH_low = config["OUTPUTPATH"] + "countFile/PAH_low.count",
        PAH_high = config["OUTPUTPATH"] + "countFile/PAH_high.count",
        PFAS_low = config["OUTPUTPATH"] + "countFile/PFAS_low.count",
        PFAS_high = config["OUTPUTPATH"] + "countFile/PFAS_high.count"
    output:
        control_PAH_low = config["OUTPUTPATH"] + "DEA/control_PAH_low",
        control_PAH_high = config["OUTPUTPATH"] + "DEA/control_PAH_high",
        control_PFAS_low = config["OUTPUTPATH"] + "DEA/control_PFAS_low",
        control_PFAS_high = config["OUTPUTPATH"] + "DEA/control_PFAS_high"
    shell:
        "paste {input.control} <(cut -f2- {input.PAH_low}) >> {output.control_PAH_low} && "
        "paste {input.control} <(cut -f2- {input.PAH_high}) >> {output.control_PAH_high} && "
        "paste {input.control} <(cut -f2- {input.PFAS_low}) >> {output.control_PFAS_low} && "
        "paste {input.control} <(cut -f2- {input.PFAS_high}) >> {output.control_PFAS_high}"

rule DEA:
    input:
        control_PAH_low = config["OUTPUTPATH"] + "DEA/control_PAH_low",
        control_PAH_high = config["OUTPUTPATH"] + "DEA/control_PAH_high",
        control_PFAS_low = config["OUTPUTPATH"] + "DEA/control_PFAS_low",
        control_PFAS_high = config["OUTPUTPATH"] + "DEA/control_PFAS_high"
    output:
        edger_control_PAH_low_dea = config["OUTPUTPATH"] + "DEA/edger/dea_control_PAH_low.csv",
        edger_control_PAH_low_deg = config["OUTPUTPATH"] + "DEA/edger/deg_control_PAH_low.csv",
        edger_control_PAH_high_dea = config["OUTPUTPATH"] + "DEA/edger/dea_control_PAH_high.csv",
        edger_control_PAH_high_deg = config["OUTPUTPATH"] + "DEA/edger/deg_control_PAH_high.csv",
        edger_control_PFAS_low_dea = config["OUTPUTPATH"] + "DEA/edger/dea_control_PFAS_low.csv",
        edger_control_PFAS_low_deg = config["OUTPUTPATH"] + "DEA/edger/deg_control_PFAS_low.csv",
        edger_control_PFAS_high_dea = config["OUTPUTPATH"] + "DEA/edger/dea_control_PFAS_high.csv",
        edger_control_PFAS_high_deg = config["OUTPUTPATH"] + "DEA/edger/deg_control_PFAS_high.csv",
        deseq2_control_PAH_low_dea = config["OUTPUTPATH"] + "DEA/deseq2/dea_control_PAH_low.csv",
        deseq2_control_PAH_low_deg = config["OUTPUTPATH"] + "DEA/deseq2/deg_control_PAH_low.csv",
        deseq2_control_PAH_high_dea = config["OUTPUTPATH"] + "DEA/deseq2/dea_control_PAH_high.csv",
        deseq2_control_PAH_high_deg = config["OUTPUTPATH"] + "DEA/deseq2/deg_control_PAH_high.csv",
        deseq2_control_PFAS_low_dea = config["OUTPUTPATH"] + "DEA/deseq2/dea_control_PFAS_low.csv",
        deseq2_control_PFAS_low_deg = config["OUTPUTPATH"] + "DEA/deseq2/deg_control_PFAS_low.csv",
        deseq2_control_PFAS_high_dea = config["OUTPUTPATH"] + "DEA/deseq2/dea_control_PFAS_high.csv",
        deseq2_control_PFAS_high_deg = config["OUTPUTPATH"] + "DEA/deseq2/deg_control_PFAS_high.csv"
    shell:
        "Rscript ../scripts/dea.edger.R {input.control_PAH_low} 6 4 {output.edger_control_PAH_low_dea} {output.edger_control_PAH_low_deg} && "
        "Rscript ../scripts/dea.edger.R {input.control_PAH_high} 6 5 {output.edger_control_PAH_high_dea} {output.edger_control_PAH_high_deg} && "
        "Rscript ../scripts/dea.edger.R {input.control_PFAS_low} 6 5 {output.edger_control_PFAS_low_dea} {output.edger_control_PFAS_low_deg} && "
        "Rscript ../scripts/dea.edger.R {input.control_PFAS_high} 6 4 {output.edger_control_PFAS_high_dea} {output.edger_control_PFAS_high_deg} && "
        "Rscript ../scripts/dea.deseq2.R {input.control_PAH_low} 6 4 {output.deseq2_control_PAH_low_dea} {output.deseq2_control_PAH_low_deg} && "
        "Rscript ../scripts/dea.deseq2.R {input.control_PAH_high} 6 5 {output.deseq2_control_PAH_high_dea} {output.deseq2_control_PAH_high_deg} && "
        "Rscript ../scripts/dea.deseq2.R {input.control_PFAS_low} 6 5 {output.deseq2_control_PFAS_low_dea} {output.deseq2_control_PFAS_low_deg} && "
        "Rscript ../scripts/dea.deseq2.R {input.control_PFAS_high} 6 4 {output.deseq2_control_PFAS_high_dea} {output.deseq2_control_PFAS_high_deg}"
