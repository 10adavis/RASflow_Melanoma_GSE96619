import pandas as pd
import numpy as np

configfile: "configs/config_dea_trans.yaml"

samples = np.array(pd.read_table(config["METAFILE"], header = 0)['sample'])
groups = np.unique(np.array(pd.read_table(config["METAFILE"], header = 0)['group']))
control = config["CONTROL"][0]
treat = config["TREAT"][0]

rule end:
    input:
        degTrans = config["OUTPUTPATH"] + "/DEA/transcript-level/" + "deg_" + control + "_" + treat + ".csv",
        degGene = config["OUTPUTPATH"] + "/DEA/gene-level/" + "deg_" + control + "_" + treat + ".csv"

rule combineSamples:
    input:
        sampleCount = expand(config["INPUTPATH"] + "/{sample}/quant.sf", sample = samples),
        metafile = config["METAFILE"]
    output:
        groupCountTrans = expand(config["OUTPUTPATH"] + "/countGroup/{group}_trans_norm.tsv", group = groups),
        groupCountGene = expand(config["OUTPUTPATH"] + "/countGroup/{group}_gene_norm.tsv", group = groups)
    shell:
        "Rscript scripts/combine2group_trans.R"

rule DEA:
    input:
        groupCountTrans = expand(config["OUTPUTPATH"] + "/countGroup/{group}_trans_norm.tsv", group = groups),
        groupCountGene = expand(config["OUTPUTPATH"] + "/countGroup/{group}_gene_norm.tsv", group = groups)
    output:
        deaTrans = config["OUTPUTPATH"] + "/DEA/transcript-level/" + "dea_" + control + "_" + treat + ".csv", 
        degTrans = config["OUTPUTPATH"] + "/DEA/transcript-level/" + "deg_" + control + "_" + treat + ".csv",
        deaGene = config["OUTPUTPATH"] + "/DEA/gene-level/" + "dea_" + control + "_" + treat + ".csv", 
        degGene = config["OUTPUTPATH"] + "/DEA/gene-level/" + "deg_" + control + "_" + treat + ".csv"
    shell:
        "Rscript scripts/dea_trans.R"
